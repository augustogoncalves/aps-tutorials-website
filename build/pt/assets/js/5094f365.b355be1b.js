"use strict";(self.webpackChunkaps_tutorials_website=self.webpackChunkaps_tutorials_website||[]).push([[700],{4137:(e,t,o)=>{o.d(t,{Zo:()=>l,kt:()=>m});var a=o(7294);function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function s(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){n(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function i(e,t){if(null==e)return{};var o,a,n=function(e,t){if(null==e)return{};var o,a,n={},r=Object.keys(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var u=a.createContext({}),c=function(e){var t=a.useContext(u),o=t;return e&&(o="function"==typeof e?e(t):s(s({},t),e)),o},l=function(e){var t=c(e.components);return a.createElement(u.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var o=e.components,n=e.mdxType,r=e.originalType,u=e.parentName,l=i(e,["components","mdxType","originalType","parentName"]),d=c(o),m=n,k=d["".concat(u,".").concat(m)]||d[m]||p[m]||r;return o?a.createElement(k,s(s({ref:t},l),{},{components:o})):a.createElement(k,s({ref:t},l))}));function m(e,t){var o=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=o.length,s=new Array(r);s[0]=d;var i={};for(var u in t)hasOwnProperty.call(t,u)&&(i[u]=t[u]);i.originalType=e,i.mdxType="string"==typeof e?e:n,s[1]=i;for(var c=2;c<r;c++)s[c]=o[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,o)}d.displayName="MDXCreateElement"},6454:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>k,contentTitle:()=>d,default:()=>h,frontMatter:()=>p,metadata:()=>m,toc:()=>f});var a=o(7462),n=(o(7294),o(4137));const r={toc:[]};function s(e){let{components:t,...o}=e;return(0,n.kt)("wrapper",(0,a.Z)({},r,o,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"Crie um arquivo 'aps.js' na pasta 'services'. \xc9 aqui que vamos implementar\ntoda a l\xf3gica APS que ser\xe1 utilizada em diferentes \xe1reas da nossa aplica\xe7\xe3o de servidor. Vamos come\xe7ar\nadicionando o seguinte c\xf3digo ao arquivo:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="services/aps.js"',title:'"services/aps.js"'},"const { SdkManagerBuilder } = require('@aps_sdk/autodesk-sdkmanager');\nconst { AuthenticationClient, Scopes, ResponseType } = require('@aps_sdk/authentication');\nconst { APS_CLIENT_ID, APS_CLIENT_SECRET, APS_CALLBACK_URL } = require('../config.js');\nconst service = module.exports = {};\nconst sdk = SdkManagerBuilder.create().build();\nconst authenticationClient = new AuthenticationClient(sdk);\nservice.getAuthorizationUrl = () => authenticationClient.authorize(APS_CLIENT_ID, ResponseType.Code, APS_CALLBACK_URL, [\n    Scopes.DataRead,\n    Scopes.AccountRead,\n    Scopes.AccountWrite\n]);\nservice.authCallbackMiddleware = async (req, res, next) => {\n    const credentials = await authenticationClient.getThreeLeggedToken(APS_CLIENT_ID, req.query.code, APS_CALLBACK_URL,{clientSecret:APS_CLIENT_SECRET});\n    req.session.token = credentials.access_token;\n    req.session.refresh_token = credentials.refresh_token;\n    req.session.expires_at = Date.now() + credentials.expires_in * 1000;\n    next();\n};\nservice.authRefreshMiddleware = async (req, res, next) => {\n    const { refresh_token, expires_at } = req.session;\n    if (!refresh_token) {\n        res.status(401).end();\n        return;\n    }\n    if (expires_at < Date.now()) {\n        const credentials = await authenticationClient.getRefreshToken(APS_CLIENT_ID, refresh_token, {\n            clientSecret: APS_CLIENT_SECRET,\n            scopes: [\n                Scopes.DataRead,\n                Scopes.AccountRead,\n                Scopes.AccountWrite\n            ]\n        });\n        req.session.token = credentials.access_token;\n        req.session.refresh_token = credentials.refresh_token;\n        req.session.expires_at = Date.now() + credentials.expires_in * 1000;\n    }\n    req.oAuthToken = {\n        access_token: req.session.token,\n        expires_in: Math.round((req.session.expires_at - Date.now()) / 1000)\n    };\n    next();\n};\nservice.getUserProfile = async (token) => {\n    const resp = await authenticationClient.getUserInfo(token.access_token);\n    return resp;\n};\n")),(0,n.kt)("p",null,"O c\xf3digo fornece algumas fun\xe7\xf5es auxiliares:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"a fun\xe7\xe3o 'getAuthorizationUrl' gera uma URL para nossos usu\xe1rios serem redirecionados para quando\nIniciando o fluxo de trabalho de autentica\xe7\xe3o de 3 pernas"),(0,n.kt)("li",{parentName:"ul"},"a fun\xe7\xe3o 'authCallbackMiddleware' pode ser usada como um middleware Express.js\nquando o usu\xe1rio faz login com \xeaxito e \xe9 redirecionado de volta ao nosso aplicativo"),(0,n.kt)("li",{parentName:"ul"},"a fun\xe7\xe3o 'authRefreshMiddleware' \xe9 ent\xe3o usada como um middleware Express.js para todas as solicita\xe7\xf5es\nque precisar\xe3o fazer uso dos tokens de acesso APS"),(0,n.kt)("li",{parentName:"ul"},"a fun\xe7\xe3o 'getUserProfile' retorna detalhes adicionais sobre o usu\xe1rio autenticado com base em\num token de acesso existente")))}s.isMDXComponent=!0;const i={toc:[]};function u(e){let{components:t,...o}=e;return(0,n.kt)("wrapper",(0,a.Z)({},i,o,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"Crie um arquivo 'auth.js' na subpasta 'rotas' com o seguinte conte\xfado:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="routes/auth.js"',title:'"routes/auth.js"'},"const express = require('express');\nconst { getAuthorizationUrl, authCallbackMiddleware, authRefreshMiddleware, getUserProfile } = require('../services/aps.js');\nlet router = express.Router();\nrouter.get('/api/auth/login', function (req, res) {\n    res.redirect(getAuthorizationUrl());\n});\nrouter.get('/api/auth/logout', function (req, res) {\n    req.session = null;\n    res.redirect('/');\n});\nrouter.get('/api/auth/callback', authCallbackMiddleware, function (req, res) {\n    res.redirect('/');\n});\nrouter.get('/api/auth/profile', authRefreshMiddleware, async function (req, res, next) {\n    try {\n        const profile = await getUserProfile(req.oAuthToken);\n        res.json({ name: `${profile.name}` });\n    } catch (err) {\n        next(err);\n    }\n});\nmodule.exports = router;\n")),(0,n.kt)("p",null,"Aqui implementamos um novo Express.js ",(0,n.kt)("a",{parentName:"p",href:"http://expressjs.com/en/4x/api.html#router"},"roteador")," que\nmanipular\xe1 todos os pontos de extremidade relacionados \xe0 autentica\xe7\xe3o. Vamos \"montar\" o roteador em nosso servidor\nmodificando 'server.js':"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="server.js"',title:'"server.js"'},"const express = require('express');\nconst session = require('cookie-session');\nconst { PORT, SERVER_SESSION_SECRET } = require('./config.js');\nlet app = express();\napp.use(express.static('wwwroot'));\napp.use(session({ secret: SERVER_SESSION_SECRET, maxAge: 24 * 60 * 60 * 1000 }));\n// highlight-start\napp.use(require('./routes/auth.js'));\n// highlight-end\napp.listen(PORT, () => console.log(`Server listening on port ${PORT}...`));\n")),(0,n.kt)("p",null,"O roteador agora lidar\xe1 com as seguintes solicita\xe7\xf5es:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"'GET /api/auth/login' redirecionar\xe1 o usu\xe1rio para a p\xe1gina de login da Autodesk"),(0,n.kt)("li",{parentName:"ul"},"'GET /api/auth/callback' \xe9 a URL para a qual nosso usu\xe1rio ser\xe1 redirecionado ap\xf3s fazer login com sucesso,\ne \xe9 onde vamos gerar um novo conjunto de tokens para o usu\xe1rio"),(0,n.kt)("li",{parentName:"ul"},"'GET /api/auth/logout' remover\xe1 quaisquer dados de sess\xe3o baseados em cookies para o usu\xe1rio em quest\xe3o, efetivamente\nEfetuando logout do usu\xe1rio em nosso aplicativo"),(0,n.kt)("li",{parentName:"ul"},"'GET /api/auth/profile' retornar\xe1 um JSON simples com informa\xe7\xf5es adicionais sobre o usu\xe1rio conectado")))}u.isMDXComponent=!0;const c={toc:[]};function l(e){let{components:t,...r}=e;return(0,n.kt)("wrapper",(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"Se o aplicativo ainda estiver em execu\xe7\xe3o, reinicie-o (por exemplo, usando ",(0,n.kt)("em",{parentName:"p"},"Run > Debugging")," Restart ,\nou clicando no \xedcone verde de reinicializa\xe7\xe3o), caso contr\xe1rio, inicie-o novamente (usando ",(0,n.kt)("em",{parentName:"p"},"Run > Debugging")," Iniciar,\nou pressionando 'F5')."),(0,n.kt)("p",null,"Quando voc\xea navega at\xe9 ",(0,n.kt)("a",{parentName:"p",href:"http://localhost:8080/api/auth/login"},"http://localhost:8080/api/auth/login"),"\nno navegador, voc\xea deve ser redirecionado para a p\xe1gina de login da Autodesk e, depois de fazer login,\nvoc\xea deve ser redirecionado de volta para o seu aplicativo, por enquanto simplesmente mostrando 'N\xe3o \xe9 poss\xedvel GET /'.\nIsso \xe9 esperado, pois ainda n\xe3o implementamos o endpoint 'GET /'. No entanto, se voc\xea usar\nferramentas de desenvolvimento do navegador e explorar os cookies armazenados pelo seu navegador para a origem 'localhost',\nVoc\xea notar\xe1 que o aplicativo j\xe1 est\xe1 armazenando os dados de autentica\xe7\xe3o l\xe1."),(0,n.kt)("admonition",{type:"info"},(0,n.kt)("p",{parentName:"admonition"},"Aqui \xe9 onde voc\xea pode encontrar os cookies do seu site em diferentes navegadores:"),(0,n.kt)("ul",{parentName:"admonition"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://developer.chrome.com/docs/devtools/storage/sessionstorage/"},"Chrome")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://developer.mozilla.org/en-US/docs/Tools/Storage_Inspector/Cookies"},"Firefox")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/microsoft-edge/devtools-guide-chromium/storage/cookies"},"Borda")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://developer.apple.com/safari/tools/"},"Safari")))),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Empty Response",src:o(4869).Z,width:"1500",height:"929"})))}l.isMDXComponent=!0;const p={},d="Autentica\xe7\xe3o",m={unversionedId:"tutorials/acc-admin/auth",id:"tutorials/acc-admin/auth",title:"Autentica\xe7\xe3o",description:"Nesta etapa, vamos estender a implementa\xe7\xe3o do servidor para que ele possa se autenticar",source:"@site/i18n/pt/docusaurus-plugin-content-docs/current/03-tutorials/05-acc-admin/02-auth.mdx",sourceDirName:"03-tutorials/05-acc-admin",slug:"/tutorials/acc-admin/auth",permalink:"/pt/tutorials/acc-admin/auth",draft:!1,editUrl:"https://github.com/autodesk-platform-services/aps-tutorials-website/edit/master/docs/03-tutorials/05-acc-admin/02-auth.mdx",tags:[],version:"current",sidebarPosition:2,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"setup",permalink:"/pt/tutorials/acc-admin/setup"},next:{title:"Navega\xe7\xe3o do Projeto",permalink:"/pt/tutorials/acc-admin/data"}},k={},f=[{value:"Tokens de acesso",id:"tokens-de-acesso",level:2},{value:"Pontos de extremidade do servidor",id:"pontos-de-extremidade-do-servidor",level:2},{value:"Experimente",id:"experimente",level:2}],g={toc:f};function h(e){let{components:t,...o}=e;return(0,n.kt)("wrapper",(0,a.Z)({},g,o,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"autentica\xe7\xe3o"},"Autentica\xe7\xe3o"),(0,n.kt)("p",null,"Nesta etapa, vamos estender a implementa\xe7\xe3o do servidor para que ele possa se autenticar\npara a plataforma APS, orientar o usu\xe1rio atrav\xe9s de um ",(0,n.kt)("a",{parentName:"p",href:"https://aps.autodesk.com/en/docs/oauth/v2/tutorials/get-3-legged-token"},"fluxo de trabalho OAuth de 3 pernas"),",\ne gerar tokens de acesso para diversas necessidades."),(0,n.kt)("h2",{id:"tokens-de-acesso"},"Tokens de acesso"),(0,n.kt)(s,{mdxType:"NodeJsVsCodeTokens"}),(0,n.kt)("h2",{id:"pontos-de-extremidade-do-servidor"},"Pontos de extremidade do servidor"),(0,n.kt)("p",null,"Agora vamos expor essa funcionalidade por meio de uma cole\xe7\xe3o de endpoints em nosso servidor."),(0,n.kt)(u,{mdxType:"NodeJsVsCodeEndpoints"}),(0,n.kt)("h2",{id:"experimente"},"Experimente"),(0,n.kt)(l,{mdxType:"NodeJsVsCodeTest"}))}h.isMDXComponent=!0},4869:(e,t,o)=>{o.d(t,{Z:()=>a});const a=o.p+"assets/images/empty-response-449d92b063a2380003d09b03f156f917.webp"}}]);